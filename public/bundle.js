const e="8/8/8/8/8/8/8/8";class t{constructor(t=e){this.squares=new Array(64).fill(null),this.setFen(t)}setFen(t=e){const s=t.replace(/^\s*/,"").replace(/\s*$/,"").split(/\/|\s/);for(let e=0;e<8;e++){const t=s[7-e].replace(/\d/g,(e=>{const t=parseInt(e);let s="";for(let e=0;e<t;e++)s+="-";return s}));for(let s=0;s<8;s++){const i=t.substring(s,s+1);let o=null;"-"!==i&&(o=i.toUpperCase()===i?`w${i.toLowerCase()}`:`b${i}`),this.squares[8*e+s]=o}}}getFen(){let e=new Array(8).fill("");for(let t=0;t<8;t++){let s=0;for(let i=0;i<8;i++){const o=this.squares[8*t+i];if(o){s>0&&(e[7-t]+=s,s=0);const i=o.substring(0,1),r=o.substring(1,2);e[7-t]+="w"===i?r.toUpperCase():r}else s++}s>0&&(e[7-t]+=s,s=0)}return e.join("/")}getPieces(e=void 0,s=void 0,i=["k","q","r","b","n","p"]){const o=[],r=(e,t)=>i.indexOf(e.name)-i.indexOf(t.name);for(let i=0;i<64;i++){const r=this.squares[i];if(r){const n=r.charAt(1),a=r.charAt(0),h=t.indexToSquare(i);if(s&&s!==n||e&&e!==a)continue;o.push({name:n,type:n,color:a,position:h,square:h})}}return i&&o.sort(r),o}movePiece(e,s){this.squares[t.squareToIndex(e)]?(this.squares[t.squareToIndex(s)]=this.squares[t.squareToIndex(e)],this.squares[t.squareToIndex(e)]=null):console.warn("no piece on",e)}setPiece(e,s){this.squares[t.squareToIndex(e)]=s}getPiece(e){return this.squares[t.squareToIndex(e)]}static squareToIndex(e){const s=t.squareToCoordinates(e);return s[0]+8*s[1]}static indexToSquare(e){return this.coordinatesToSquare([Math.floor(e%8),e/8])}static squareToCoordinates(e){return[e.charCodeAt(0)-97,e.charCodeAt(1)-49]}static coordinatesToSquare(e){return String.fromCharCode(e[0]+97)+String.fromCharCode(e[1]+49)}toString(){return this.getFen()}clone(){const e=new t;return e.squares=this.squares.slice(0),e}}class s{constructor(){this.position=new t,this.orientation=void 0,this.inputWhiteEnabled=!1,this.inputBlackEnabled=!1,this.squareSelectEnabled=!1,this.moveInputCallback=null,this.extensionPoints={},this.moveInputProcess=Promise.resolve()}inputEnabled(){return this.inputWhiteEnabled||this.inputBlackEnabled}invokeExtensionPoints(e,t={}){const s=this.extensionPoints[e],i=Object.assign({},t);i.extensionPoint=e;let o=!0;if(s)for(const e of s)!1===e(i)&&(o=!1);return o}}const i="http://www.w3.org/2000/svg";class o{static createSvg(e=void 0){let t=document.createElementNS(i,"svg");return e&&(t.setAttribute("width","100%"),t.setAttribute("height","100%"),e.appendChild(t)),t}static addElement(e,t,s={}){let o=document.createElementNS(i,t);"use"===t&&(s["xlink:href"]=s.href);for(let e in s)if(s.hasOwnProperty(e))if(-1!==e.indexOf(":")){const t=e.split(":");o.setAttributeNS("http://www.w3.org/1999/"+t[0],t[1],s[e])}else o.setAttribute(e,s[e]);return e.appendChild(o),o}static removeElement(e){e?e.parentNode?e.parentNode.removeChild(e):console.warn(e,"without parentNode"):console.warn("removeElement, element is",e)}}const r="positionChanged",n="boardChanged",a="moveInputToggled",h="moveInput",c="beforeRedrawBoard",l="afterRedrawBoard",u="animation",d="destroy";class p{static delegate(e,t,s,i){const o=function(e){let t=e.target;for(;t&&t!==this;)t.matches(s)&&i.call(t,e),t=t.parentNode};return e.addEventListener(t,o),{remove:function(){e.removeEventListener(t,o)}}}static mergeObjects(e,t){const s=e=>e&&"object"==typeof e;if(!s(e)||!s(t))return t;for(const s of Object.keys(t))t[s]instanceof Object&&Object.assign(t[s],p.mergeObjects(e[s],t[s]));return Object.assign(e||{},t),e}static createDomElement(e){const t=document.createElement("template");return t.innerHTML=e.trim(),t.content.firstChild}static createTask(){let e,t;const s=new Promise((function(s,i){e=s,t=i}));return s.resolve=e,s.reject=t,s}static isAbsoluteUrl(e){return-1!==e.indexOf("://")||e.startsWith("/")}}const m="start",b="frame",v="end";class g{constructor(){this.queue=[],this.workingOnPromise=!1,this.stop=!1}async enqueue(e){return new Promise(((t,s)=>{this.queue.push({promise:e,resolve:t,reject:s}),this.dequeue()}))}dequeue(){if(this.workingOnPromise)return;if(this.stop)return this.queue=[],void(this.stop=!1);const e=this.queue.shift();if(e){try{this.workingOnPromise=!0,e.promise().then((t=>{this.workingOnPromise=!1,e.resolve(t),this.dequeue()})).catch((t=>{this.workingOnPromise=!1,e.reject(t),this.dequeue()}))}catch(t){this.workingOnPromise=!1,e.reject(t),this.dequeue()}return!0}}destroy(){this.stop=!0}}const f=0,_=1,S=2;class k{constructor(e,t,s,i,o){this.view=e,t&&s?(this.animatedElements=this.createAnimation(t.squares,s.squares),this.duration=i,this.callback=o,this.frameHandle=requestAnimationFrame(this.animationStep.bind(this))):console.error("fromPosition",t,"toPosition",s),this.view.positionsAnimationTask=p.createTask(),this.view.chessboard.state.invokeExtensionPoints(u,{type:m})}static seekChanges(e,t){const s=[],i=[],o=[];for(let o=0;o<64;o++){const r=e[o],n=t[o];n!==r&&(n&&s.push({piece:n,index:o}),r&&i.push({piece:r,index:o}))}return s.forEach((e=>{let t=8,s=null;i.forEach((i=>{if(e.piece===i.piece){const o=k.squareDistance(e.index,i.index);o<t&&(s=i,t=o)}})),s?(i.splice(i.indexOf(s),1),o.push({type:f,piece:e.piece,atIndex:s.index,toIndex:e.index})):o.push({type:_,piece:e.piece,atIndex:e.index})})),i.forEach((e=>{o.push({type:S,piece:e.piece,atIndex:e.index})})),o}createAnimation(e,s){const i=k.seekChanges(e,s),o=[];return i.forEach((e=>{const s={type:e.type};switch(e.type){case f:s.element=this.view.getPieceElement(t.indexToSquare(e.atIndex)),s.element.parentNode.appendChild(s.element),s.atPoint=this.view.indexToPoint(e.atIndex),s.toPoint=this.view.indexToPoint(e.toIndex);break;case _:s.element=this.view.drawPieceOnSquare(t.indexToSquare(e.atIndex),e.piece),s.element.style.opacity=0;break;case S:s.element=this.view.getPieceElement(t.indexToSquare(e.atIndex))}o.push(s)})),o}animationStep(e){if(!this.view||!this.view.chessboard.state)return;this.startTime||(this.startTime=e);const t=e-this.startTime;if(!(t<=this.duration))return cancelAnimationFrame(this.frameHandle),this.animatedElements.forEach((e=>{e.type===S&&o.removeElement(e.element)})),this.view.positionsAnimationTask.resolve(),this.view.chessboard.state.invokeExtensionPoints(u,{type:v}),void this.callback();this.frameHandle=requestAnimationFrame(this.animationStep.bind(this));const s=Math.min(1,t/this.duration);let i=s<.5?2*s*s:(4-2*s)*s-1;(isNaN(i)||i>.99)&&(i=1),this.animatedElements.forEach((e=>{if(e.element)switch(e.type){case f:e.element.transform.baseVal.removeItem(0);const t=this.view.svg.createSVGTransform();t.setTranslate(e.atPoint.x+(e.toPoint.x-e.atPoint.x)*i,e.atPoint.y+(e.toPoint.y-e.atPoint.y)*i),e.element.transform.baseVal.appendItem(t);break;case _:e.element.style.opacity=Math.round(100*i)/100;break;case S:e.element.style.opacity=Math.round(100*(1-i))/100}else console.warn("animatedItem has no element",e)})),this.view.chessboard.state.invokeExtensionPoints(u,{type:b,progress:i})}static squareDistance(e,t){const s=e%8,i=Math.floor(e/8),o=t%8,r=Math.floor(t/8);return Math.max(Math.abs(r-i),Math.abs(o-s))}}class w extends g{constructor(e){super(),this.chessboard=e}async enqueuePositionChange(e,t,s){return e.getFen()===t.getFen()?Promise.resolve():super.enqueue((()=>new Promise((i=>{let o=s?this.chessboard.props.style.animationDuration:0;this.queue.length>0&&(o/=1+Math.pow(this.queue.length/5,2)),new k(this.chessboard.view,e,t,s?o:0,(()=>{this.chessboard.view&&this.chessboard.view.redrawPieces(t.squares),i()}))}))))}async enqueueTurnBoard(s,i,o){return super.enqueue((()=>new Promise((r=>{const n=new t(e);let a=o?this.chessboard.props.style.animationDuration:0;this.queue.length>0&&(a/=1+Math.pow(this.queue.length/5,2)),new k(this.chessboard.view,s,n,o?a:0,(()=>{this.chessboard.state.orientation=i,this.chessboard.view.redrawBoard(),this.chessboard.view.redrawPieces(n.squares),new k(this.chessboard.view,n,s,o?a:0,(()=>{this.chessboard.view.redrawPieces(s.squares),r()}))}))}))))}}const E={waitForInputStart:"waitForInputStart",pieceClickedThreshold:"pieceClickedThreshold",clickTo:"clickTo",secondClickThreshold:"secondClickThreshold",dragTo:"dragTo",clickDragTo:"clickDragTo",moveDone:"moveDone",reset:"reset"},C="secondClick",q="secondaryClick",y="movedOutOfBoard",I="draggedBack",P="clickedAnotherPiece";class T{constructor(e){this.view=e,this.chessboard=e.chessboard,this.moveInputState=null,this.fromSquare=null,this.toSquare=null,this.setMoveInputState(E.waitForInputStart)}moveInputStartedCallback(e){const t=this.view.moveInputStartedCallback(e);return t&&(this.chessboard.state.moveInputProcess=p.createTask(),this.chessboard.state.moveInputProcess.then((e=>{this.moveInputState!==E.waitForInputStart&&this.moveInputState!==E.moveDone||this.view.moveInputFinishedCallback(this.fromSquare,this.toSquare,e)}))),t}movingOverSquareCallback(e,t){this.view.movingOverSquareCallback(e,t)}validateMoveInputCallback(e,t){const s=this.view.validateMoveInputCallback(e,t);return this.chessboard.state.moveInputProcess.resolve(s),s}moveInputCanceledCallback(e,t,s){this.view.moveInputCanceledCallback(e,t,s),this.chessboard.state.moveInputProcess.resolve()}setMoveInputState(e,t=void 0){const s=this.moveInputState;switch(this.moveInputState=e,e){case E.waitForInputStart:break;case E.pieceClickedThreshold:if(E.waitForInputStart!==s&&E.clickTo!==s)throw new Error("moveInputState");if(this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=null),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=null),this.fromSquare=t.square,this.toSquare=null,this.movedPiece=t.piece,this.startPoint=t.point,this.pointerMoveListener||this.pointerUpListener)throw Error("94ad0c");if("mousedown"===t.type)this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="mousemove",addEventListener("mousemove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="mouseup",addEventListener("mouseup",this.pointerUpListener);else{if("touchstart"!==t.type)throw Error("4b74af");this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="touchmove",addEventListener("touchmove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="touchend",addEventListener("touchend",this.pointerUpListener)}this.contextMenuListener||(this.contextMenuListener=this.onContextMenu.bind(this),this.chessboard.view.svg.addEventListener("contextmenu",this.contextMenuListener));break;case E.clickTo:this.draggablePiece&&(o.removeElement(this.draggablePiece),this.draggablePiece=null),s===E.dragTo&&this.view.setPieceVisibility(t.square,!0);break;case E.secondClickThreshold:if(E.clickTo!==s)throw new Error("moveInputState");this.startPoint=t.point;break;case E.dragTo:if(E.pieceClickedThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled()&&(this.view.setPieceVisibility(t.square,!1),this.createDraggablePiece(t.piece));break;case E.clickDragTo:if(E.secondClickThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled()&&(this.view.setPieceVisibility(t.square,!1),this.createDraggablePiece(t.piece));break;case E.moveDone:if(-1===[E.dragTo,E.clickTo,E.clickDragTo].indexOf(s))throw new Error("moveInputState");this.toSquare=t.square,this.toSquare&&this.validateMoveInputCallback(this.fromSquare,this.toSquare)?this.chessboard.movePiece(this.fromSquare,this.toSquare,s===E.clickTo).then((()=>{s===E.clickTo&&this.view.setPieceVisibility(this.toSquare,!0),this.setMoveInputState(E.reset)})):(this.view.setPieceVisibility(this.fromSquare,!0),this.setMoveInputState(E.reset));break;case E.reset:this.fromSquare&&!this.toSquare&&this.movedPiece&&this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.fromSquare=null,this.toSquare=null,this.movedPiece=null,this.draggablePiece&&(o.removeElement(this.draggablePiece),this.draggablePiece=null),this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=null),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=null),this.contextMenuListener&&(removeEventListener("contextmenu",this.contextMenuListener),this.contextMenuListener=null),this.setMoveInputState(E.waitForInputStart);const i=this.view.piecesGroup.querySelectorAll("[visibility=hidden]");for(let e=0;e<i.length;e++)i[e].removeAttribute("visibility");break;default:throw Error(`260b09: moveInputState ${e}`)}}createDraggablePiece(e){if(this.draggablePiece)throw Error("draggablePiece already exists");this.draggablePiece=o.createSvg(document.body),this.draggablePiece.classList.add("cm-chessboard-draggable-piece"),this.draggablePiece.setAttribute("width",this.view.squareWidth),this.draggablePiece.setAttribute("height",this.view.squareHeight),this.draggablePiece.setAttribute("style","pointer-events: none"),this.draggablePiece.name=e;const t=this.chessboard.props.assetsCache?"":this.view.getSpriteUrl(),s=o.addElement(this.draggablePiece,"use",{href:`${t}#${e}`}),i=this.view.squareHeight/this.chessboard.props.style.pieces.tileSize,r=this.draggablePiece.createSVGTransform();r.setScale(i,i),s.transform.baseVal.appendItem(r)}moveDraggablePiece(e,t){this.draggablePiece.setAttribute("style",`pointer-events: none; position: absolute; left: ${e-this.view.squareHeight/2}px; top: ${t-this.view.squareHeight/2}px`)}onPointerDown(e){if(("mousedown"!==e.type||0!==e.button)&&"touchstart"!==e.type)return;const t=e.target.getAttribute("data-square");if(!t)return;const s=this.chessboard.getPiece(t);let i;if(s&&(i=s?s.substring(0,1):null,("w"===i&&this.chessboard.state.inputWhiteEnabled||"b"===i&&this.chessboard.state.inputBlackEnabled)&&e.preventDefault()),this.moveInputState!==E.waitForInputStart||this.chessboard.state.inputWhiteEnabled&&"w"===i||this.chessboard.state.inputBlackEnabled&&"b"===i){let o;if("mousedown"===e.type?o={x:e.clientX,y:e.clientY}:"touchstart"===e.type&&(o={x:e.touches[0].clientX,y:e.touches[0].clientY}),this.moveInputState===E.waitForInputStart&&s&&this.moveInputStartedCallback(t))this.setMoveInputState(E.pieceClickedThreshold,{square:t,piece:s,point:o,type:e.type});else if(this.moveInputState===E.clickTo)if(t===this.fromSquare)this.setMoveInputState(E.secondClickThreshold,{square:t,piece:s,point:o,type:e.type});else{const s=this.chessboard.getPiece(t),r=s?s.substring(0,1):null,n=this.chessboard.getPiece(this.fromSquare),a=n?n.substring(0,1):null;i&&a===r?(this.moveInputCanceledCallback(this.fromSquare,t,P),this.moveInputStartedCallback(t)?this.setMoveInputState(E.pieceClickedThreshold,{square:t,piece:s,point:o,type:e.type}):this.setMoveInputState(E.reset)):this.setMoveInputState(E.moveDone,{square:t})}}}onPointerMove(e){let t,s,i,o,r;if("mousemove"===e.type?(i=e.clientX,o=e.clientY,t=e.pageX,s=e.pageY,r=e.target):"touchmove"===e.type&&(i=e.touches[0].clientX,o=e.touches[0].clientY,t=e.touches[0].pageX,s=e.touches[0].pageY,r=document.elementFromPoint(i,o)),this.moveInputState===E.pieceClickedThreshold||this.moveInputState===E.secondClickThreshold)(Math.abs(this.startPoint.x-i)>4||Math.abs(this.startPoint.y-o)>4)&&(this.moveInputState===E.secondClickThreshold?this.setMoveInputState(E.clickDragTo,{square:this.fromSquare,piece:this.movedPiece}):this.setMoveInputState(E.dragTo,{square:this.fromSquare,piece:this.movedPiece}),this.view.chessboard.state.inputEnabled()&&this.moveDraggablePiece(t,s));else if(this.moveInputState===E.dragTo||this.moveInputState===E.clickDragTo||this.moveInputState===E.clickTo){if(r&&r.getAttribute&&r.parentElement===this.view.boardGroup){const e=r.getAttribute("data-square");e!==this.fromSquare&&e!==this.toSquare?(this.toSquare=e,this.movingOverSquareCallback(this.fromSquare,this.toSquare)):e===this.fromSquare&&null!==this.toSquare&&(this.toSquare=null,this.movingOverSquareCallback(this.fromSquare,null))}else null!==this.toSquare&&(this.toSquare=null,this.movingOverSquareCallback(this.fromSquare,null));!this.view.chessboard.state.inputEnabled()||this.moveInputState!==E.dragTo&&this.moveInputState!==E.clickDragTo||this.moveDraggablePiece(t,s)}}onPointerUp(e){let t;if("mouseup"===e.type?t=e.target:"touchend"===e.type&&(t=document.elementFromPoint(e.changedTouches[0].clientX,e.changedTouches[0].clientY)),t&&t.getAttribute){const e=t.getAttribute("data-square");if(e)this.moveInputState===E.dragTo||this.moveInputState===E.clickDragTo?this.fromSquare===e?this.moveInputState===E.clickDragTo?(this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.view.setPieceVisibility(this.fromSquare),this.moveInputCanceledCallback(e,null,I),this.setMoveInputState(E.reset)):this.setMoveInputState(E.clickTo,{square:e}):this.setMoveInputState(E.moveDone,{square:e}):this.moveInputState===E.pieceClickedThreshold?this.setMoveInputState(E.clickTo,{square:e}):this.moveInputState===E.secondClickThreshold&&(this.setMoveInputState(E.reset),this.moveInputCanceledCallback(e,null,C));else{this.view.redrawPieces();const e=this.fromSquare;this.setMoveInputState(E.reset),this.moveInputCanceledCallback(e,null,y)}}else this.view.redrawPieces(),this.setMoveInputState(E.reset)}onContextMenu(e){e.preventDefault(),this.view.redrawPieces(),this.setMoveInputState(E.reset),this.moveInputCanceledCallback(this.fromSquare,null,q)}isDragging(){return this.moveInputState===E.dragTo||this.moveInputState===E.clickDragTo}destroy(){this.setMoveInputState(E.reset)}}const x="w",L="b",A="moveInputStarted",M="movingOverSquare",D="validateMoveInput",O="moveInputCanceled",N="moveInputFinished",R="pointerdown",F="none",U="thin",z="frame";class G{constructor(e){this.chessboard=e,this.visualMoveInput=new T(this),e.props.assetsCache&&this.cacheSpriteToDiv("cm-chessboard-sprite",this.getSpriteUrl()),this.container=document.createElement("div"),this.chessboard.context.appendChild(this.container),e.props.responsive&&("undefined"!=typeof ResizeObserver?(this.resizeObserver=new ResizeObserver((()=>{setTimeout((()=>{this.handleResize()}))})),this.resizeObserver.observe(this.chessboard.context)):(this.resizeListener=this.handleResize.bind(this),window.addEventListener("resize",this.resizeListener))),this.positionsAnimationTask=Promise.resolve(),this.pointerDownListener=this.pointerDownHandler.bind(this),this.container.addEventListener("mousedown",this.pointerDownListener),this.container.addEventListener("touchstart",this.pointerDownListener,{passive:!1}),this.createSvgAndGroups(),this.handleResize()}pointerDownHandler(e){this.visualMoveInput.onPointerDown(e)}destroy(){this.visualMoveInput.destroy(),this.resizeObserver&&this.resizeObserver.unobserve(this.chessboard.context),this.resizeListener&&window.removeEventListener("resize",this.resizeListener),this.chessboard.context.removeEventListener("mousedown",this.pointerDownListener),this.chessboard.context.removeEventListener("touchstart",this.pointerDownListener),o.removeElement(this.svg),this.container.remove()}cacheSpriteToDiv(e,t){if(!document.getElementById(e)){const s=document.createElement("div");s.style.transform="scale(0)",s.style.position="absolute",s.setAttribute("aria-hidden","true"),s.id=e,document.body.appendChild(s);const i=new XMLHttpRequest;i.open("GET",t,!0),i.onload=function(){s.insertAdjacentHTML("afterbegin",i.response)},i.send()}}createSvgAndGroups(){this.svg=o.createSvg(this.container);let e=this.chessboard.props.style.cssClass?this.chessboard.props.style.cssClass:"default";this.svg.setAttribute("class","cm-chessboard border-type-"+this.chessboard.props.style.borderType+" "+e),this.svg.setAttribute("role","img"),this.updateMetrics(),this.boardGroup=o.addElement(this.svg,"g",{class:"board"}),this.coordinatesGroup=o.addElement(this.svg,"g",{class:"coordinates","aria-hidden":"true"}),this.markersLayer=o.addElement(this.svg,"g",{class:"markers-layer"}),this.piecesLayer=o.addElement(this.svg,"g",{class:"pieces-layer"}),this.piecesGroup=o.addElement(this.piecesLayer,"g",{class:"pieces"}),this.markersTopLayer=o.addElement(this.svg,"g",{class:"markers-top-layer"}),this.interactiveTopLayer=o.addElement(this.svg,"g",{class:"interactive-top-layer"})}updateMetrics(){const e=this.chessboard.props.style.pieces.tileSize;this.width=this.container.clientWidth,this.height=this.container.clientWidth*(this.chessboard.props.style.aspectRatio||1),this.chessboard.props.style.borderType===z?this.borderSize=this.width/25:this.chessboard.props.style.borderType===U?this.borderSize=this.width/320:this.borderSize=0,this.innerWidth=this.width-2*this.borderSize,this.innerHeight=this.height-2*this.borderSize,this.squareWidth=this.innerWidth/8,this.squareHeight=this.innerHeight/8,this.scalingX=this.squareWidth/e,this.scalingY=this.squareHeight/e,this.pieceXTranslate=this.squareWidth/2-e*this.scalingY/2}handleResize(){this.container.style.width=this.chessboard.context.clientWidth+"px",this.container.style.height=this.chessboard.context.clientWidth*this.chessboard.props.style.aspectRatio+"px",this.container.clientWidth===this.width&&this.container.clientHeight===this.height||(this.updateMetrics(),this.redrawBoard(),this.redrawPieces()),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%")}redrawBoard(){this.chessboard.state.invokeExtensionPoints(c),this.redrawSquares(),this.drawCoordinates(),this.chessboard.state.invokeExtensionPoints(l),this.visualizeInputState()}redrawSquares(){for(;this.boardGroup.firstChild;)this.boardGroup.removeChild(this.boardGroup.lastChild);if(o.addElement(this.boardGroup,"rect",{width:this.width,height:this.height}).setAttribute("class","border"),this.chessboard.props.style.borderType===z){const e=this.borderSize;o.addElement(this.boardGroup,"rect",{x:e,y:e,width:this.width-2*e,height:this.height-2*e}).setAttribute("class","border-inner")}for(let e=0;e<64;e++){const s=this.chessboard.state.orientation===x?e:63-e,i=`square ${9*s&8?"white":"black"}`,r=this.squareToPoint(t.indexToSquare(s)),n=o.addElement(this.boardGroup,"rect",{x:r.x,y:r.y,width:this.squareWidth,height:this.squareHeight});n.setAttribute("class",i),n.setAttribute("data-square",t.indexToSquare(s))}}drawCoordinates(){if(!this.chessboard.props.style.showCoordinates)return;for(;this.coordinatesGroup.firstChild;)this.coordinatesGroup.removeChild(this.coordinatesGroup.lastChild);const e=this.chessboard.props.style.borderType!==z;for(let t=0;t<8;t++){let s=this.borderSize+(17+this.chessboard.props.style.pieces.tileSize*t)*this.scalingX,i=this.height-3.5*this.scalingY,r="coordinate file";e&&(s+=15.5*this.scalingX,r+=t%2?" white":" black");const n=o.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${10*this.scalingY}px`});this.chessboard.state.orientation===x?n.textContent=String.fromCharCode(97+t):n.textContent=String.fromCharCode(104-t)}for(let t=0;t<8;t++){let s=this.borderSize/3.7,i=this.borderSize+25*this.scalingY+t*this.squareHeight,r="coordinate rank";e&&(r+=t%2?" black":" white",this.chessboard.props.style.borderType===z?(s+=10*this.scalingX,i-=15*this.scalingY):(s+=2*this.scalingX,i-=15*this.scalingY));const n=o.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${10*this.scalingY}px`});this.chessboard.state.orientation===x?n.textContent=""+(8-t):n.textContent=""+(1+t)}}redrawPieces(e=this.chessboard.state.position.squares){const s=Array.from(this.piecesGroup.childNodes),i=this.visualMoveInput.isDragging();for(let s=0;s<64;s++){const o=e[s];if(o){const e=t.indexToSquare(s);this.drawPieceOnSquare(e,o,i&&e===this.visualMoveInput.fromSquare)}}for(const e of s)this.piecesGroup.removeChild(e)}drawPiece(e,t,s){const i=o.addElement(e,"g",{});i.setAttribute("data-piece",t);const r=this.svg.createSVGTransform();r.setTranslate(s.x,s.y),i.transform.baseVal.appendItem(r);const n=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),a=o.addElement(i,"use",{href:`${n}#${t}`,class:"piece"}),h=this.svg.createSVGTransform();return h.setScale(this.scalingY,this.scalingY),a.transform.baseVal.appendItem(h),i}drawPieceOnSquare(e,t,s=!1){const i=o.addElement(this.piecesGroup,"g",{});i.setAttribute("data-piece",t),i.setAttribute("data-square",e),s&&i.setAttribute("visibility","hidden");const r=this.squareToPoint(e),n=this.svg.createSVGTransform();n.setTranslate(r.x,r.y),i.transform.baseVal.appendItem(n);const a=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),h=o.addElement(i,"use",{href:`${a}#${t}`,class:"piece"}),c=this.svg.createSVGTransform();c.setTranslate(this.pieceXTranslate,0),h.transform.baseVal.appendItem(c);const l=this.svg.createSVGTransform();return l.setScale(this.scalingY,this.scalingY),h.transform.baseVal.appendItem(l),i}setPieceVisibility(e,t=!0){const s=this.getPieceElement(e);s?t?s.setAttribute("visibility","visible"):s.setAttribute("visibility","hidden"):console.warn("no piece on",e)}getPieceElement(e){if(!e||e.length<2)return console.warn("invalid square",e),null;const t=this.piecesGroup.querySelector(`g[data-square='${e}']`);return t||(console.warn("no piece on",e),null)}enableMoveInput(e,t=null){if(this.chessboard.state.moveInputCallback)throw Error("moveInput already enabled");t===x?this.chessboard.state.inputWhiteEnabled=!0:(t===L||(this.chessboard.state.inputWhiteEnabled=!0),this.chessboard.state.inputBlackEnabled=!0),this.chessboard.state.moveInputCallback=e,this.chessboard.state.invokeExtensionPoints(a,{enabled:!0,color:t}),this.visualizeInputState()}disableMoveInput(){this.chessboard.state.inputWhiteEnabled=!1,this.chessboard.state.inputBlackEnabled=!1,this.chessboard.state.moveInputCallback=null,this.chessboard.state.invokeExtensionPoints(a,{enabled:!1}),this.visualizeInputState()}moveInputStartedCallback(e){const t={chessboard:this.chessboard,type:A,square:e,squareFrom:e,piece:this.chessboard.getPiece(e)};return this.chessboard.state.moveInputCallback&&(t.moveInputCallbackResult=this.chessboard.state.moveInputCallback(t)),this.chessboard.state.invokeExtensionPoints(h,t),t.moveInputCallbackResult}movingOverSquareCallback(e,t){const s={chessboard:this.chessboard,type:M,squareFrom:e,squareTo:t,piece:this.chessboard.getPiece(e)};this.chessboard.state.moveInputCallback&&(s.moveInputCallbackResult=this.chessboard.state.moveInputCallback(s)),this.chessboard.state.invokeExtensionPoints(h,s)}validateMoveInputCallback(e,t){const s={chessboard:this.chessboard,type:D,squareFrom:e,squareTo:t,piece:this.chessboard.getPiece(e)};return this.chessboard.state.moveInputCallback&&(s.moveInputCallbackResult=this.chessboard.state.moveInputCallback(s)),this.chessboard.state.invokeExtensionPoints(h,s),s.moveInputCallbackResult}moveInputCanceledCallback(e,t,s){const i={chessboard:this.chessboard,type:O,reason:s,squareFrom:e,squareTo:t};this.chessboard.state.moveInputCallback&&this.chessboard.state.moveInputCallback(i),this.chessboard.state.invokeExtensionPoints(h,i)}moveInputFinishedCallback(e,t,s){const i={chessboard:this.chessboard,type:N,squareFrom:e,squareTo:t,legalMove:s};this.chessboard.state.moveInputCallback&&this.chessboard.state.moveInputCallback(i),this.chessboard.state.invokeExtensionPoints(h,i)}visualizeInputState(){this.chessboard.state&&(this.chessboard.state.inputWhiteEnabled||this.chessboard.state.inputBlackEnabled?this.boardGroup.setAttribute("class","board input-enabled"):this.boardGroup.setAttribute("class","board"))}indexToPoint(e){let t,s;return this.chessboard.state.orientation===x?(t=this.borderSize+e%8*this.squareWidth,s=this.borderSize+(7-Math.floor(e/8))*this.squareHeight):(t=this.borderSize+(7-e%8)*this.squareWidth,s=this.borderSize+Math.floor(e/8)*this.squareHeight),{x:t,y:s}}squareToPoint(e){const s=t.squareToIndex(e);return this.indexToPoint(s)}getSpriteUrl(){return p.isAbsoluteUrl(this.chessboard.props.style.pieces.file)?this.chessboard.props.style.pieces.file:this.chessboard.props.assetsUrl+this.chessboard.props.style.pieces.file}}const $="svgSprite";class B{constructor(i,o={}){if(!i)throw new Error("container element is "+i);this.context=i,this.id=(Math.random()+1).toString(36).substring(2,8),this.extensions=[],this.props={position:e,orientation:x,responsive:!0,assetsUrl:"./assets/",assetsCache:!0,style:{cssClass:"default",showCoordinates:!0,borderType:F,aspectRatio:1,pieces:{type:$,file:"pieces/standard.svg",tileSize:40},animationDuration:300},extensions:[]},p.mergeObjects(this.props,o),this.state=new s,this.view=new G(this),this.positionAnimationsQueue=new w(this),this.state.orientation=this.props.orientation;for(const e of this.props.extensions)this.addExtension(e.class,e.props);this.view.redrawBoard(),this.state.position=new t(this.props.position),this.view.redrawPieces(),this.state.invokeExtensionPoints(r),this.initialized=Promise.resolve()}async setPiece(e,t,s=!1){const i=this.state.position.clone();return this.state.position.setPiece(e,t),this.state.invokeExtensionPoints(r),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async movePiece(e,t,s=!1){const i=this.state.position.clone();return this.state.position.movePiece(e,t),this.state.invokeExtensionPoints(r),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async setPosition(e,s=!1){const i=this.state.position.clone(),o=new t(e);return i.getFen()!==o.getFen()&&(this.state.position.setFen(e),this.state.invokeExtensionPoints(r)),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async setOrientation(e,t=!1){const s=this.state.position.clone();if(!this.boardTurning)return this.boardTurning=!0,this.positionAnimationsQueue.enqueueTurnBoard(s,e,t).then((()=>{this.boardTurning=!1,this.state.invokeExtensionPoints(n)}));console.warn("setOrientation is only once in queue allowed")}getPiece(e){return this.state.position.getPiece(e)}getPosition(){return this.state.position.getFen()}getOrientation(){return this.state.orientation}enableMoveInput(e,t=void 0){this.view.enableMoveInput(e,t)}disableMoveInput(){this.view.disableMoveInput()}isMoveInputEnabled(){return this.state.inputWhiteEnabled||this.state.inputBlackEnabled}enableSquareSelect(e=R,t){this.squareSelectListener||(this.squareSelectListener=function(e){const s=e.target.getAttribute("data-square");t({eventType:e.type,event:e,chessboard:this,square:s})}),this.context.addEventListener(e,this.squareSelectListener),this.state.squareSelectEnabled=!0,this.view.visualizeInputState()}disableSquareSelect(e){this.context.removeEventListener(e,this.squareSelectListener),this.squareSelectListener=void 0,this.state.squareSelectEnabled=!1,this.view.visualizeInputState()}isSquareSelectEnabled(){return this.state.squareSelectEnabled}addExtension(e,t){if(this.getExtension(e))throw Error('extension "'+e.name+'" already added');this.extensions.push(new e(this,t))}getExtension(e){for(const t of this.extensions)if(t instanceof e)return t;return null}destroy(){this.state.invokeExtensionPoints(d),this.positionAnimationsQueue.destroy(),this.view.destroy(),this.view=void 0,this.state=void 0}}
/**
 * @license
 * Copyright (c) 2023, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const Q="w",K="b",W="p",H="b",j="r",V="q",Y="k",X="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",J=-1,Z={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},ee={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},te={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},se={b:[16,32,17,15],w:[-16,-32,-17,-15]},ie={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},oe=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],re=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],ne={p:1,n:2,b:4,r:8,q:16,k:32},ae=["n",H,j,V],he={[Y]:ee.KSIDE_CASTLE,[V]:ee.QSIDE_CASTLE},ce={w:[{square:te.a1,flag:ee.QSIDE_CASTLE},{square:te.h1,flag:ee.KSIDE_CASTLE}],b:[{square:te.a8,flag:ee.QSIDE_CASTLE},{square:te.h8,flag:ee.KSIDE_CASTLE}]},le={b:1,w:6},ue=["1-0","0-1","1/2-1/2","*"];function de(e){return e>>4}function pe(e){return 15&e}function me(e){return-1!=="0123456789".indexOf(e)}function be(e){const t=pe(e),s=de(e);return"abcdefgh".substring(t,t+1)+"87654321".substring(s,s+1)}function ve(e){return e===Q?K:Q}function ge(e,t,s,i,o,r=void 0,n=ee.NORMAL){const a=de(i);if(o!==W||7!==a&&0!==a)e.push({color:t,from:s,to:i,piece:o,captured:r,flags:n});else for(let a=0;a<ae.length;a++){const h=ae[a];e.push({color:t,from:s,to:i,piece:o,captured:r,promotion:h,flags:n|ee.PROMOTION})}}function fe(e){let t=e.charAt(0);if(t>="a"&&t<="h"){if(e.match(/[a-h]\d.*[a-h]\d/))return;return W}return t=t.toLowerCase(),"o"===t?Y:t}function _e(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function Se(e){return e.split(" ").slice(0,4).join(" ")}class ke{_board=new Array(128);_turn=Q;_header={};_kings={w:J,b:J};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_positionCount={};constructor(e=X){this.load(e)}clear({preserveHeaders:e=!1}={}){this._board=new Array(128),this._kings={w:J,b:J},this._turn=Q,this._castling={w:0,b:0},this._epSquare=J,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=e?this._header:{},this._positionCount={},delete this._header.SetUp,delete this._header.FEN}removeHeader(e){e in this._header&&delete this._header[e]}load(e,{skipValidation:t=!1,preserveHeaders:s=!1}={}){let i=e.split(/\s+/);if(i.length>=2&&i.length<6){const t=["-","-","0","1"];e=i.concat(t.slice(-(6-i.length))).join(" ")}if(i=e.split(/\s+/),!t){const{ok:t,error:s}=function(e){const t=e.split(/\s+/);if(6!==t.length)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const s=parseInt(t[5],10);if(isNaN(s)||s<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const i=parseInt(t[4],10);if(isNaN(i)||i<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const o=t[0].split("/");if(8!==o.length)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let e=0;e<o.length;e++){let t=0,s=!1;for(let i=0;i<o[e].length;i++)if(me(o[e][i])){if(s)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};t+=parseInt(o[e][i],10),s=!0}else{if(!/^[prnbqkPRNBQK]$/.test(o[e][i]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};t+=1,s=!1}if(8!==t)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if("3"==t[3][1]&&"w"==t[1]||"6"==t[3][1]&&"b"==t[1])return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const r=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:e,regex:s}of r){if(!s.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${e} king`};if((t[0].match(s)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${e} kings`}}return Array.from(o[0]+o[7]).some((e=>"P"===e.toUpperCase()))?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}(e);if(!t)throw new Error(s)}const o=i[0];let r=0;this.clear({preserveHeaders:s});for(let e=0;e<o.length;e++){const t=o.charAt(e);if("/"===t)r+=8;else if(me(t))r+=parseInt(t,10);else{const e=t<"a"?Q:K;this._put({type:t.toLowerCase(),color:e},be(r)),r++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=ee.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=ee.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=ee.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=ee.QSIDE_CASTLE),this._epSquare="-"===i[3]?J:te[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._updateSetup(e),this._incPositionCount(e)}fen(){let e=0,t="";for(let s=te.a8;s<=te.h1;s++){if(this._board[s]){e>0&&(t+=e,e=0);const{color:i,type:o}=this._board[s];t+=i===Q?o.toUpperCase():o.toLowerCase()}else e++;s+1&136&&(e>0&&(t+=e),s!==te.h1&&(t+="/"),e=0,s+=8)}let s="";this._castling[Q]&ee.KSIDE_CASTLE&&(s+="K"),this._castling[Q]&ee.QSIDE_CASTLE&&(s+="Q"),this._castling[K]&ee.KSIDE_CASTLE&&(s+="k"),this._castling[K]&ee.QSIDE_CASTLE&&(s+="q"),s=s||"-";let i="-";if(this._epSquare!==J){const e=this._epSquare+(this._turn===Q?16:-16),t=[e+1,e-1];for(const e of t){if(136&e)continue;const t=this._turn;if(this._board[e]?.color===t&&this._board[e]?.type===W){this._makeMove({color:t,from:e,to:this._epSquare,piece:W,captured:W,flags:ee.EP_CAPTURE});const s=!this._isKingAttacked(t);if(this._undoMove(),s){i=be(this._epSquare);break}}}}return[t,this._turn,s,i,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(e){this._history.length>0||(e!==X?(this._header.SetUp="1",this._header.FEN=e):(delete this._header.SetUp,delete this._header.FEN))}reset(){this.load(X)}get(e){return this._board[te[e]]||!1}put({type:e,color:t},s){return!!this._put({type:e,color:t},s)&&(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0)}_put({type:e,color:t},s){if(-1==="pnbrqkPNBRQK".indexOf(e.toLowerCase()))return!1;if(!(s in te))return!1;const i=te[s];if(e==Y&&this._kings[t]!=J&&this._kings[t]!=i)return!1;const o=this._board[i];return o&&o.type===Y&&(this._kings[o.color]=J),this._board[i]={type:e,color:t},e===Y&&(this._kings[t]=i),!0}remove(e){const t=this.get(e);return delete this._board[te[e]],t&&t.type===Y&&(this._kings[t.color]=J),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),t}_updateCastlingRights(){const e=this._board[te.e1]?.type===Y&&this._board[te.e1]?.color===Q,t=this._board[te.e8]?.type===Y&&this._board[te.e8]?.color===K;e&&this._board[te.a1]?.type===j&&this._board[te.a1]?.color===Q||(this._castling.w&=~ee.QSIDE_CASTLE),e&&this._board[te.h1]?.type===j&&this._board[te.h1]?.color===Q||(this._castling.w&=~ee.KSIDE_CASTLE),t&&this._board[te.a8]?.type===j&&this._board[te.a8]?.color===K||(this._castling.b&=~ee.QSIDE_CASTLE),t&&this._board[te.h8]?.type===j&&this._board[te.h8]?.color===K||(this._castling.b&=~ee.KSIDE_CASTLE)}_updateEnPassantSquare(){if(this._epSquare===J)return;const e=this._epSquare+(this._turn===Q?-16:16),t=this._epSquare+(this._turn===Q?16:-16),s=[t+1,t-1];if(null!==this._board[e]||null!==this._board[this._epSquare]||this._board[t]?.color!==ve(this._turn)||this._board[t]?.type!==W)return void(this._epSquare=J);s.some((e=>!(136&e)&&this._board[e]?.color===this._turn&&this._board[e]?.type===W))||(this._epSquare=J)}_attacked(e,t){for(let s=te.a8;s<=te.h1;s++){if(136&s){s+=7;continue}if(void 0===this._board[s]||this._board[s].color!==e)continue;const i=this._board[s],o=s-t;if(0===o)continue;const r=o+119;if(oe[r]&ne[i.type]){if(i.type===W){if(o>0){if(i.color===Q)return!0}else if(i.color===K)return!0;continue}if("n"===i.type||"k"===i.type)return!0;const e=re[r];let n=s+e,a=!1;for(;n!==t;){if(null!=this._board[n]){a=!0;break}n+=e}if(!a)return!0}}return!1}_isKingAttacked(e){const t=this._kings[e];return-1!==t&&this._attacked(ve(e),t)}isAttacked(e,t){return this._attacked(t,te[e])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&0===this._moves().length}isStalemate(){return!this.isCheck()&&0===this._moves().length}isInsufficientMaterial(){const e={b:0,n:0,r:0,q:0,k:0,p:0},t=[];let s=0,i=0;for(let o=te.a8;o<=te.h1;o++){if(i=(i+1)%2,136&o){o+=7;continue}const r=this._board[o];r&&(e[r.type]=r.type in e?e[r.type]+1:1,r.type===H&&t.push(i),s++)}if(2===s)return!0;if(3===s&&(1===e[H]||1===e.n))return!0;if(s===e[H]+2){let e=0;const s=t.length;for(let i=0;i<s;i++)e+=t[i];if(0===e||e===s)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this.fen())>=3}isDraw(){return this._halfMoves>=100||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:e=!1,square:t,piece:s}={}){const i=this._moves({square:t,piece:s});return e?i.map((e=>this._makePretty(e))):i.map((e=>this._moveToSan(e,i)))}_moves({legal:e=!0,piece:t,square:s}={}){const i=s?s.toLowerCase():void 0,o=t?.toLowerCase(),r=[],n=this._turn,a=ve(n);let h=te.a8,c=te.h1,l=!1;if(i){if(!(i in te))return[];h=c=te[i],l=!0}for(let e=h;e<=c;e++){if(136&e){e+=7;continue}if(!this._board[e]||this._board[e].color===a)continue;const{type:t}=this._board[e];let s;if(t===W){if(o&&o!==t)continue;s=e+se[n][0],this._board[s]||(ge(r,n,e,s,W),s=e+se[n][1],le[n]!==de(e)||this._board[s]||ge(r,n,e,s,W,void 0,ee.BIG_PAWN));for(let t=2;t<4;t++)s=e+se[n][t],136&s||(this._board[s]?.color===a?ge(r,n,e,s,W,this._board[s].type,ee.CAPTURE):s===this._epSquare&&ge(r,n,e,s,W,W,ee.EP_CAPTURE))}else{if(o&&o!==t)continue;for(let i=0,o=ie[t].length;i<o;i++){const o=ie[t][i];for(s=e;s+=o,!(136&s);){if(this._board[s]){if(this._board[s].color===n)break;ge(r,n,e,s,t,this._board[s].type,ee.CAPTURE);break}if(ge(r,n,e,s,t),"n"===t||t===Y)break}}}}if(!(void 0!==o&&o!==Y||l&&c!==this._kings[n])){if(this._castling[n]&ee.KSIDE_CASTLE){const e=this._kings[n],t=e+2;this._board[e+1]||this._board[t]||this._attacked(a,this._kings[n])||this._attacked(a,e+1)||this._attacked(a,t)||ge(r,n,this._kings[n],t,Y,void 0,ee.KSIDE_CASTLE)}if(this._castling[n]&ee.QSIDE_CASTLE){const e=this._kings[n],t=e-2;this._board[e-1]||this._board[e-2]||this._board[e-3]||this._attacked(a,this._kings[n])||this._attacked(a,e-1)||this._attacked(a,t)||ge(r,n,this._kings[n],t,Y,void 0,ee.QSIDE_CASTLE)}}if(!e||-1===this._kings[n])return r;const u=[];for(let e=0,t=r.length;e<t;e++)this._makeMove(r[e]),this._isKingAttacked(n)||u.push(r[e]),this._undoMove();return u}move(e,{strict:t=!1}={}){let s=null;if("string"==typeof e)s=this._moveFromSan(e,t);else if("object"==typeof e){const t=this._moves();for(let i=0,o=t.length;i<o;i++)if(e.from===be(t[i].from)&&e.to===be(t[i].to)&&(!("promotion"in t[i])||e.promotion===t[i].promotion)){s=t[i];break}}if(!s)throw"string"==typeof e?new Error(`Invalid move: ${e}`):new Error(`Invalid move: ${JSON.stringify(e)}`);const i=this._makePretty(s);return this._makeMove(s),this._incPositionCount(i.after),i}_push(e){this._history.push({move:e,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(e){const t=this._turn,s=ve(t);if(this._push(e),this._board[e.to]=this._board[e.from],delete this._board[e.from],e.flags&ee.EP_CAPTURE&&(this._turn===K?delete this._board[e.to-16]:delete this._board[e.to+16]),e.promotion&&(this._board[e.to]={type:e.promotion,color:t}),this._board[e.to].type===Y){if(this._kings[t]=e.to,e.flags&ee.KSIDE_CASTLE){const t=e.to-1,s=e.to+1;this._board[t]=this._board[s],delete this._board[s]}else if(e.flags&ee.QSIDE_CASTLE){const t=e.to+1,s=e.to-2;this._board[t]=this._board[s],delete this._board[s]}this._castling[t]=0}if(this._castling[t])for(let s=0,i=ce[t].length;s<i;s++)if(e.from===ce[t][s].square&&this._castling[t]&ce[t][s].flag){this._castling[t]^=ce[t][s].flag;break}if(this._castling[s])for(let t=0,i=ce[s].length;t<i;t++)if(e.to===ce[s][t].square&&this._castling[s]&ce[s][t].flag){this._castling[s]^=ce[s][t].flag;break}e.flags&ee.BIG_PAWN?this._epSquare=t===K?e.to-16:e.to+16:this._epSquare=J,e.piece===W||e.flags&(ee.CAPTURE|ee.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,t===K&&this._moveNumber++,this._turn=s}undo(){const e=this._undoMove();if(e){const t=this._makePretty(e);return this._decPositionCount(t.after),t}return null}_undoMove(){const e=this._history.pop();if(void 0===e)return null;const t=e.move;this._kings=e.kings,this._turn=e.turn,this._castling=e.castling,this._epSquare=e.epSquare,this._halfMoves=e.halfMoves,this._moveNumber=e.moveNumber;const s=this._turn,i=ve(s);if(this._board[t.from]=this._board[t.to],this._board[t.from].type=t.piece,delete this._board[t.to],t.captured)if(t.flags&ee.EP_CAPTURE){let e;e=s===K?t.to-16:t.to+16,this._board[e]={type:W,color:i}}else this._board[t.to]={type:t.captured,color:i};if(t.flags&(ee.KSIDE_CASTLE|ee.QSIDE_CASTLE)){let e,s;t.flags&ee.KSIDE_CASTLE?(e=t.to+1,s=t.to-1):(e=t.to-2,s=t.to+1),this._board[e]=this._board[s],delete this._board[s]}return t}pgn({newline:e="\n",maxWidth:t=0}={}){const s=[];let i=!1;for(const t in this._header)s.push("["+t+' "'+this._header[t]+'"]'+e),i=!0;i&&this._history.length&&s.push(e);const o=e=>{const t=this._comments[this.fen()];if(void 0!==t){e=`${e}${e.length>0?" ":""}{${t}}`}return e},r=[];for(;this._history.length>0;)r.push(this._undoMove());const n=[];let a="";for(0===r.length&&n.push(o(""));r.length>0;){a=o(a);const e=r.pop();if(!e)break;if(this._history.length||"b"!==e.color)"w"===e.color&&(a.length&&n.push(a),a=this._moveNumber+".");else{const e=`${this._moveNumber}. ...`;a=a?`${a} ${e}`:e}a=a+" "+this._moveToSan(e,this._moves({legal:!0})),this._makeMove(e)}if(a.length&&n.push(o(a)),void 0!==this._header.Result&&n.push(this._header.Result),0===t)return s.join("")+n.join(" ");const h=function(){return s.length>0&&" "===s[s.length-1]&&(s.pop(),!0)},c=function(i,o){for(const r of o.split(" "))if(r){if(i+r.length>t){for(;h();)i--;s.push(e),i=0}s.push(r),i+=r.length,s.push(" "),i++}return h()&&i--,i};let l=0;for(let i=0;i<n.length;i++)l+n[i].length>t&&n[i].includes("{")?l=c(l,n[i]):(l+n[i].length>t&&0!==i?(" "===s[s.length-1]&&s.pop(),s.push(e),l=0):0!==i&&(s.push(" "),l++),s.push(n[i]),l+=n[i].length);return s.join("")}header(...e){for(let t=0;t<e.length;t+=2)"string"==typeof e[t]&&"string"==typeof e[t+1]&&(this._header[e[t]]=e[t+1]);return this._header}loadPgn(e,{strict:t=!1,newlineChar:s="\r?\n"}={}){function i(e){return e.replace(/\\/g,"\\")}e=e.trim();const o=new RegExp("^(\\[((?:"+i(s)+")|.)*\\])((?:\\s*"+i(s)+"){2}|(?:\\s*"+i(s)+")*$)").exec(e),r=o&&o.length>=2?o[1]:"";this.reset();const n=function(e){const t={},o=e.split(new RegExp(i(s)));let r="",n="";for(let e=0;e<o.length;e++){const s=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;r=o[e].replace(s,"$1"),n=o[e].replace(s,"$2"),r.trim().length>0&&(t[r]=n)}return t}(r);let a="";for(const e in n)"fen"===e.toLowerCase()&&(a=n[e]),this.header(e,n[e]);if(t){if("1"===n.SetUp){if(!("FEN"in n))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(n.FEN,{preserveHeaders:!0})}}else a&&this.load(a,{preserveHeaders:!0});const h=function(e){return`{${function(e){return Array.from(e).map((function(e){return e.charCodeAt(0)<128?e.charCodeAt(0).toString(16):encodeURIComponent(e).replace(/%/g,"").toLowerCase()})).join("")}((e=e.replace(new RegExp(i(s),"g")," ")).slice(1,e.length-1))}}`},c=function(e){if(e.startsWith("{")&&e.endsWith("}"))return function(e){return 0==e.length?"":decodeURIComponent("%"+(e.match(/.{1,2}/g)||[]).join("%"))}(e.slice(1,e.length-1))};let l=e.replace(r,"").replace(new RegExp(`({[^}]*})+?|;([^${i(s)}]*)`,"g"),(function(e,t,s){return void 0!==t?h(t):" "+h(`{${s.slice(1)}}`)})).replace(new RegExp(i(s),"g")," ");const u=/(\([^()]+\))+?/g;for(;u.test(l);)l=l.replace(u,"");l=l.replace(/\d+\.(\.\.)?/g,""),l=l.replace(/\.\.\./g,""),l=l.replace(/\$\d+/g,"");let d=l.trim().split(new RegExp(/\s+/));d=d.filter((e=>""!==e));let p="";for(let e=0;e<d.length;e++){const s=c(d[e]);if(void 0!==s){this._comments[this.fen()]=s;continue}const i=this._moveFromSan(d[e],t);if(null==i){if(!(ue.indexOf(d[e])>-1))throw new Error(`Invalid move in PGN: ${d[e]}`);p=d[e]}else p="",this._makeMove(i),this._incPositionCount(this.fen())}p&&Object.keys(this._header).length&&!this._header.Result&&this.header("Result",p)}_moveToSan(e,t){let s="";if(e.flags&ee.KSIDE_CASTLE)s="O-O";else if(e.flags&ee.QSIDE_CASTLE)s="O-O-O";else{if(e.piece!==W){const i=function(e,t){const s=e.from,i=e.to,o=e.piece;let r=0,n=0,a=0;for(let e=0,h=t.length;e<h;e++){const h=t[e].from,c=t[e].to;o===t[e].piece&&s!==h&&i===c&&(r++,de(s)===de(h)&&n++,pe(s)===pe(h)&&a++)}return r>0?n>0&&a>0?be(s):a>0?be(s).charAt(1):be(s).charAt(0):""}(e,t);s+=e.piece.toUpperCase()+i}e.flags&(ee.CAPTURE|ee.EP_CAPTURE)&&(e.piece===W&&(s+=be(e.from)[0]),s+="x"),s+=be(e.to),e.promotion&&(s+="="+e.promotion.toUpperCase())}return this._makeMove(e),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(e,t=!1){const s=_e(e);let i,o,r,n,a,h=fe(s),c=this._moves({legal:!0,piece:h});for(let e=0,t=c.length;e<t;e++)if(s===_e(this._moveToSan(c[e],c)))return c[e];if(t)return null;let l=!1;if(o=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),o?(i=o[1],r=o[2],n=o[3],a=o[4],1==r.length&&(l=!0)):(o=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),o&&(i=o[1],r=o[2],n=o[3],a=o[4],1==r.length&&(l=!0))),h=fe(s),c=this._moves({legal:!0,piece:i||h}),!n)return null;for(let e=0,t=c.length;e<t;e++)if(r){if(!(i&&i.toLowerCase()!=c[e].piece||te[r]!=c[e].from||te[n]!=c[e].to||a&&a.toLowerCase()!=c[e].promotion))return c[e];if(l){const t=be(c[e].from);if(!(i&&i.toLowerCase()!=c[e].piece||te[n]!=c[e].to||r!=t[0]&&r!=t[1]||a&&a.toLowerCase()!=c[e].promotion))return c[e]}}else if(s===_e(this._moveToSan(c[e],c)).replace("x",""))return c[e];return null}ascii(){let e="   +------------------------+\n";for(let t=te.a8;t<=te.h1;t++){if(0===pe(t)&&(e+=" "+"87654321"[de(t)]+" |"),this._board[t]){const s=this._board[t].type;e+=" "+(this._board[t].color===Q?s.toUpperCase():s.toLowerCase())+" "}else e+=" . ";t+1&136&&(e+="|\n",t+=8)}return e+="   +------------------------+\n",e+="     a  b  c  d  e  f  g  h",e}perft(e){const t=this._moves({legal:!1});let s=0;const i=this._turn;for(let o=0,r=t.length;o<r;o++)this._makeMove(t[o]),this._isKingAttacked(i)||(e-1>0?s+=this.perft(e-1):s++),this._undoMove();return s}_makePretty(e){const{color:t,piece:s,from:i,to:o,flags:r,captured:n,promotion:a}=e;let h="";for(const e in ee)ee[e]&r&&(h+=Z[e]);const c=be(i),l=be(o),u={color:t,piece:s,from:c,to:l,san:this._moveToSan(e,this._moves({legal:!0})),flags:h,lan:c+l,before:this.fen(),after:""};return this._makeMove(e),u.after=this.fen(),this._undoMove(),n&&(u.captured=n),a&&(u.promotion=a,u.lan+=a),u}turn(){return this._turn}board(){const e=[];let t=[];for(let s=te.a8;s<=te.h1;s++)null==this._board[s]?t.push(null):t.push({square:be(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(e.push(t),t=[],s+=8);return e}squareColor(e){if(e in te){const t=te[e];return(de(t)+pe(t))%2==0?"light":"dark"}return null}history({verbose:e=!1}={}){const t=[],s=[];for(;this._history.length>0;)t.push(this._undoMove());for(;;){const i=t.pop();if(!i)break;e?s.push(this._makePretty(i)):s.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return s}_getPositionCount(e){const t=Se(e);return this._positionCount[t]||0}_incPositionCount(e){const t=Se(e);void 0===this._positionCount[t]&&(this._positionCount[t]=0),this._positionCount[t]+=1}_decPositionCount(e){const t=Se(e);1===this._positionCount[t]?delete this._positionCount[t]:this._positionCount[t]-=1}_pruneComments(){const e=[],t={},s=e=>{e in this._comments&&(t[e]=this._comments[e])};for(;this._history.length>0;)e.push(this._undoMove());for(s(this.fen());;){const t=e.pop();if(!t)break;this._makeMove(t),s(this.fen())}this._comments=t}getComment(){return this._comments[this.fen()]}setComment(e){this._comments[this.fen()]=e.replace("{","[").replace("}","]")}deleteComment(){const e=this._comments[this.fen()];return delete this._comments[this.fen()],e}getComments(){return this._pruneComments(),Object.keys(this._comments).map((e=>({fen:e,comment:this._comments[e]})))}deleteComments(){return this._pruneComments(),Object.keys(this._comments).map((e=>{const t=this._comments[e];return delete this._comments[e],{fen:e,comment:t}}))}setCastlingRights(e,t){for(const s of[Y,V])void 0!==t[s]&&(t[s]?this._castling[e]|=he[s]:this._castling[e]&=~he[s]);this._updateCastlingRights();const s=this.getCastlingRights(e);return!(void 0!==t[Y]&&t[Y]!==s[Y]||void 0!==t[V]&&t[V]!==s[V])}getCastlingRights(e){return{[Y]:!!(this._castling[e]&he[Y]),[V]:!!(this._castling[e]&he[V])}}moveNumber(){return this._moveNumber}}class we{constructor(e){this.chess=new ke,this.board=new B(e,{position:this.chess.fen(),assetsUrl:"assets/",style:{showCoordinates:!0,borderType:"thin",pieces:{file:"pieces/standard.svg"}}}),this.initializeGame()}initializeGame(){this.board.enableMoveInput(this.inputHandler.bind(this))}inputHandler(e){switch(e.type){case A:return!0;case D:const t={from:e.squareFrom,to:e.squareTo};return!!this.chess.move(t)&&(this.board.setPosition(this.chess.fen()),this.updateStatus(),!0)}}updateStatus(){const e=document.getElementById("status");let t="";this.chess.isCheckmate()?t="Game Over - Checkmate!":this.chess.isDraw()?t="Game Over - Draw!":(t="Current turn: "+("w"===this.chess.turn()?"White":"Black"),this.chess.isCheck()&&(t+=" (Check)")),e.textContent=t}newGame(){this.chess.reset(),this.board.setPosition(this.chess.fen()),this.updateStatus()}undoMove(){this.chess.undo(),this.board.setPosition(this.chess.fen()),this.updateStatus()}}document.addEventListener("DOMContentLoaded",(()=>{const e=new we(document.getElementById("board"));document.getElementById("startBtn").addEventListener("click",(()=>{e.newGame()})),document.getElementById("undoBtn").addEventListener("click",(()=>{e.undoMove()}))}));
//# sourceMappingURL=bundle.js.map
